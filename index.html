(function() {
  var telegramUrl = 'https://t.me/realpyroservice';
  var btn = document.getElementById('joinBtn');
  var timer = document.getElementById('timer');
  var modal = document.getElementById('modal');
  var openBtn = document.getElementById('openBtn');
  var cancelBtn = document.getElementById('cancelBtn');
  var instructions = document.getElementById('instructions');
  var subtitle = document.getElementById('subtitle');

  var holdTimer = null;
  var countdown = null;
  var holdDuration = 2000;

  // Detect URL parameter for TikTok
  const urlParams = new URLSearchParams(window.location.search);
  const fromTikTok = urlParams.get('tiktok') === '1';

  // Detect in-app browser
  var ua = navigator.userAgent || '';
  var isInApp = /TikTok|Instagram|FBAN|FBAV|Line|LinkedIn/i.test(ua);

  if (fromTikTok) {
    // Show instructions for TikTok visitors
    subtitle.textContent = 'Follow the instructions below to open in Safari.';
    instructions.classList.remove('hidden');
    btn.textContent = 'Open Instructions';

    // When clicked, scroll to instructions
    btn.onclick = function() {
      instructions.scrollIntoView({behavior:'smooth'});
    };
    return; // Don't initialize hold-to-join
  }

  if (isInApp) {
    subtitle.textContent = 'Follow the instructions below';
    instructions.classList.remove('hidden');
    btn.textContent = 'Open Instructions';
    btn.onclick = function() {
      instructions.scrollIntoView({behavior:'smooth'});
    };
    return;
  }

  // Function to start hold
  function startHold() {
    btn.classList.add('holding');
    var remaining = 2;
    timer.textContent = remaining;

    countdown = setInterval(function() {
      remaining--;
      if (remaining > 0) {
        timer.textContent = remaining;
      }
    }, 1000);

    holdTimer = setTimeout(function() {
      clearInterval(countdown);
      timer.textContent = '';
      btn.classList.remove('holding');
      // Show modal to open Telegram
      modal.classList.add('show');
    }, holdDuration);
  }

  function stopHold() {
    btn.classList.remove('holding');
    clearTimeout(holdTimer);
    clearInterval(countdown);
    timer.textContent = '';
  }

  // Event listeners for hold button (touch/mouse)
  btn.addEventListener('touchstart', function(e) {
    e.preventDefault();
    startHold();
  });
  btn.addEventListener('touchend', function(e) {
    e.preventDefault();
    stopHold();
  });
  btn.addEventListener('touchcancel', function(e) {
    e.preventDefault();
    stopHold();
  });
  btn.addEventListener('mousedown', function(e) {
    e.preventDefault();
    startHold();
  });
  btn.addEventListener('mouseup', function(e) {
    e.preventDefault();
    stopHold();
  });
  btn.addEventListener('mouseleave', stopHold);

  // Modal actions
  openBtn.addEventListener('click', function() {
    modal.classList.remove('show');
    timer.textContent = 'âœ“';
    window.location.href = telegramUrl;
  });

  cancelBtn.addEventListener('click', function() {
    modal.classList.remove('show');
  });

  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.classList.remove('show');
    }
  });
})();
